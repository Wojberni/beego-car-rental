# Table of contents

- [Table of contents](#table-of-contents)
  - [Project Description](#project-description)
  - [Installation](#installation)
  - [Makefile configuration](#makefile-configuration)
  - [Project structure](#project-structure)
  - [Tips for bee tool](#tips-for-bee-tool)
    - [Swagger Docs](#swagger-docs)
    - [Database migrations](#database-migrations)
    - [Dockerizing application](#dockerizing-application)
    - [Autogenerating resources](#autogenerating-resources)


## Project Description
This my sandbox project for learning Golang with Beego framework. I am using bee tool to manage my project.

## Installation

After cloning the repository to run the project you must have golang installed on your computer. Recommended version is 18+. Link for [Go install](https://go.dev/doc/install). 

**(Optional)** Now create workspace, so the VSCode can reference the needed dependencies. I found this very useful, when working with VSCode. This will generate a go.work file, where all module names will be stored. When creating a new module just remember to add `go work use $DIRECTORY` to add directory to workspace. Now go into parent directory and run commands given below.

```bash
    go work init
    go work use beego-car-rental
```

Lastly, go into project directory and run

```bash
    go mod tidy
```

This will download all the dependencies needed and generate `go.sum` file. Now we can build and run the server using standard go commands.

```bash
    go build main.go
    ./beego-car-rental
```

As an alternative you can install bee tool and use it to run project. More information on installing [bee tool](https://beego.gocn.vip/beego/en-US/developing/bee/). 

> Tip: Use `go install` instead of `go get` for newer versions of Golang.

## Makefile configuration

Makefile is a very convenient way of automating many tasks, that you will run frequently. Instead of writing long commands manually and remembering all the parameters for the bee tool, you can automate all that with makefile commands. Here are some available commands you can use to automate the project with `make`:

* `run` - run app, download and generate swagger docs
* `update-router` - generate comments router and generate docs
* `docker-run` - create database and app container from docker compose file
* `docker-stop` - stop the containers and removes them
* `db-migrate-dev` - migrate dev database
* `db-rollback-dev` - rollback dev database migration
* `db-reset-dev` - reset dev database
* `db-update-dev` - update dev database

## Project structure

Project is simple and every folder is a different package, which has different purpose in project.

- `conf` - storing configuration and loading configuration on init
- `controllers` - controller definitions with routes annotated with commments (necessary for generated docs)
- `database` - sql migrations and initializing database and users when creating a new database
- `docker` - docker compose and other files used to compose whole infrastructure
- `dtos` - Data Table Objects used for sending appropiate requests
- `models` - entities and methods to save them to database
- `routers` - router and generated router from controller comments
- `services` - all business logic
- `static` - static pages
- `swagger` - autogenerated swagger docs
- `test` - unit tests and integration tests
- `utils` - helper functions used for general purpose
- `views` - views templates that will be rendered

Annotations are crucial for using the namespaced router type. When using beego namespaces in the router, the router and the controllers must be annotated to be able to generate docs.

## Tips for bee tool

Bee tool proved very useful for managing beego server. With commands it provide you can automate many tasks. I use it for running the project, generating Swagger docs, dockerizing app. But the documentation is lacking information, so I will try to explain some of the problems you might come across when using `bee`.

### Swagger Docs

Swagger docs are autogenerated. Beego has integrated static Swagger docs for developing purposes. In your project directory run:

```bash
    bee generate docs
    bee run
    # alternative command to autodownload swagger file and autogenerate docs
    bee run -gendoc -downdoc
```

This command will autogenerate docs in `/swagger` directory in your project. Now after setting property `beego.SetStaticPath("/swagger", "swagger")` in `main.go` file you will be able to access swagger on your `/swagger` endpoint. You might need to run `bee generate routers` to autogenerate annotated with comments router. That information from this autogenerated `commentsRouter` is used while creating docs using tool.

> **Bug**
> 
> `swagger.json` and `swagger.yaml` are storing generated configuration of your swagger. There was a bug, where configuration wasn't imported from `swagger.json` file. You might change URL to `/swagger/swagger.json` in `window.onload` function, that is being called in `index.html` file.

### Database migrations

Database migrations are crucial to keep your schema consistent. ORMs are often unreliable and can cause some unwanted bugs. Beego ORM will **not** delete obsolete tables, that have been either renamed or removed. That is why database migrations are the best way to version your database schema. 
List of commands thath you can use to run database migrations:

* migrate - run all migrations
* rollback - rollback last migration
* reset - rollback all migrations
* refresh - update your schema

```bash
# Example migrate command with parameters
    bee migrate -driver=postgres -conn=postgres://dev:1234@localhost/beego_car_rental_dev?sslmode=disable
```

> **Bug**
>  
> After running all db migrations and than rollbacking the migrations, you cannot run all the migrations again. As a result, you have to delete rows in `migrations` table.

### Dockerizing application

With a command `bee dockerize` you can autogenerate a `Dockerfile` with `docker-compose.yaml`, that you can use to dockerize you app. It can be used as a template for building your whole app config (e.g. add database and other services). Now run:

```bash
    docker-compose up -d
    # -d for detached mode run in background
```

After a minute app and database should be up and running.

### Autogenerating resources

You can autogenerate resources with `bee generate [command]`. List of available commands:

* migration *file* - creates migration file with methods to migrate and rollback database migration

// TODO: bee generate scaffold overview

// TODO: bee generate controller overview

// TODO: bee generate tests overview

// TODO: bee generate view overview

// TODO: bee generate model overview

// TODO: bee generate docs overview

// TODO: bee generate comments routers

// TODO: bee generate appcode based on existing database